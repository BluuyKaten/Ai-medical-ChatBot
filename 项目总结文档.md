# ç¡…è°·å°æ™ºï¼ˆåŒ»ç–—ç‰ˆï¼‰é¡¹ç›®æ€»ç»“æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°
ç¡…è°·å°æ™ºï¼ˆåŒ»ç–—ç‰ˆï¼‰- AIæ™ºèƒ½åŒ»ç–—åŠ©æ‰‹ç³»ç»Ÿ

### é¡¹ç›®ç®€ä»‹
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºSpring Boot + Vue.js + LangChain4jçš„æ™ºèƒ½åŒ»ç–—åŠ©æ‰‹ç³»ç»Ÿï¼Œé›†æˆäº†å¤šç§AIå¤§æ¨¡å‹ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ã€OpenAIã€Ollamaï¼‰ï¼Œæä¾›åŒ»ç–—å’¨è¯¢ã€æ™ºèƒ½åˆ†è¯Šã€é¢„çº¦æŒ‚å·ç­‰åŠŸèƒ½çš„æ™ºèƒ½å®¢æœç³»ç»Ÿã€‚

### é¡¹ç›®ç‰¹è‰²
- ğŸ¥ **åŒ»ç–—ä¸“ä¸šåŒ–**ï¼šä¸“æ³¨äºåŒ»ç–—åœºæ™¯çš„æ™ºèƒ½åŠ©æ‰‹
- ğŸ¤– **å¤šæ¨¡å‹æ”¯æŒ**ï¼šæ”¯æŒé˜¿é‡Œäº‘ç™¾ç‚¼ã€OpenAIã€Ollamaç­‰å¤šç§AIæ¨¡å‹
- ğŸ’¬ **æµå¼å¯¹è¯**ï¼šæ”¯æŒå®æ—¶æµå¼å“åº”ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- ğŸ§  **è®°å¿†åŠŸèƒ½**ï¼šåŸºäºMongoDBçš„å¯¹è¯è®°å¿†å­˜å‚¨
- ğŸ”§ **å·¥å…·é›†æˆ**ï¼šé›†æˆé¢„çº¦æŒ‚å·ã€è®¡ç®—å™¨ç­‰å®ç”¨å·¥å…·
- ğŸ“± **ç°ä»£åŒ–UI**ï¼šåŸºäºElement Plusçš„ç°ä»£åŒ–å‰ç«¯ç•Œé¢

## æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Spring Boot 3.2.6
- **AIæ¡†æ¶**: LangChain4j 1.0.0-beta3
- **æ•°æ®åº“**: MySQL 8.0 + MongoDB 6.0
- **ORM**: MyBatis Plus
- **APIæ–‡æ¡£**: Knife4j (Swagger)
- **æ„å»ºå·¥å…·**: Maven
- **Javaç‰ˆæœ¬**: JDK 17

### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Vue 3.5.13
- **UIç»„ä»¶åº“**: Element Plus 2.8.4
- **æ„å»ºå·¥å…·**: Vite 5.4.8
- **HTTPå®¢æˆ·ç«¯**: Axios 1.7.7
- **å·¥å…·åº“**: UUID 10.0.0

### AIæ¨¡å‹æ”¯æŒ
1. **é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°**
   - èŠå¤©æ¨¡å‹: qwen-plus
   - åµŒå…¥æ¨¡å‹: text-embedding-v4
   - æµå¼èŠå¤©æ¨¡å‹: qwen-plus

2. **OpenAIå…¼å®¹æ¨¡å‹**
   - æ¨¡å‹: gpt-4o-mini
   - æ”¯æŒæµå¼å“åº”

3. **Ollamaæœ¬åœ°æ¨¡å‹**
   - æ¨¡å‹: deepseek-r1:latest
   - æœ¬åœ°éƒ¨ç½²ï¼Œæ”¯æŒç¦»çº¿ä½¿ç”¨

## é¡¹ç›®ç»“æ„

### åç«¯ç›®å½•ç»“æ„
```
src/main/java/com/wj/aiTest/
â”œâ”€â”€ AiTestApplication.java          # å¯åŠ¨ç±»
â”œâ”€â”€ controller/                     # æ§åˆ¶å™¨å±‚
â”‚   â””â”€â”€ XiaozhiController.java     # å°æ™ºå¯¹è¯æ§åˆ¶å™¨
â”œâ”€â”€ assistant/                      # AIåŠ©æ‰‹æ¥å£
â”‚   â”œâ”€â”€ Assistant.java             # åŸºç¡€åŠ©æ‰‹æ¥å£
â”‚   â”œâ”€â”€ XiaozhiAgent.java         # å°æ™ºæ™ºèƒ½ä½“
â”‚   â”œâ”€â”€ SeparateChatAssistant.java # åˆ†ç¦»å¼èŠå¤©åŠ©æ‰‹
â”‚   â””â”€â”€ MemoryChatAssistant.java   # è®°å¿†èŠå¤©åŠ©æ‰‹
â”œâ”€â”€ config/                        # é…ç½®ç±»
â”‚   â”œâ”€â”€ XiaozhiAgentConfig.java   # å°æ™ºæ™ºèƒ½ä½“é…ç½®
â”‚   â”œâ”€â”€ EmbeddingStoreConfig.java # å‘é‡å­˜å‚¨é…ç½®
â”‚   â”œâ”€â”€ SeparateChatAssistantConfig.java # åˆ†ç¦»å¼åŠ©æ‰‹é…ç½®
â”‚   â””â”€â”€ MemoryChatAssistantConfig.java   # è®°å¿†åŠ©æ‰‹é…ç½®
â”œâ”€â”€ tools/                         # å·¥å…·ç±»
â”‚   â”œâ”€â”€ AppointmentTools.java     # é¢„çº¦æŒ‚å·å·¥å…·
â”‚   â””â”€â”€ CalculatorTools.java      # è®¡ç®—å™¨å·¥å…·
â”œâ”€â”€ service/                       # æœåŠ¡å±‚
â”‚   â””â”€â”€ impl/
â”‚       â””â”€â”€ AppointmentServiceImpl.java # é¢„çº¦æœåŠ¡å®ç°
â”œâ”€â”€ entity/                        # å®ä½“ç±»
â”‚   â””â”€â”€ Appointment.java          # é¢„çº¦å®ä½“
â”œâ”€â”€ mapper/                        # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ AppointmentMapper.java    # é¢„çº¦æ•°æ®è®¿é—®
â”œâ”€â”€ store/                         # å­˜å‚¨å±‚
â”‚   â””â”€â”€ MongoChatMemoryStore.java # MongoDBèŠå¤©è®°å¿†å­˜å‚¨
â””â”€â”€ bean/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
    â”œâ”€â”€ ChatForm.java             # èŠå¤©è¡¨å•
    â””â”€â”€ ChatMessages.java         # èŠå¤©æ¶ˆæ¯
```

### å‰ç«¯ç›®å½•ç»“æ„
```
xiaozhi-ui/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ ChatWindow.vue       # èŠå¤©çª—å£ç»„ä»¶
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ logo.png            # é¡¹ç›®logo
â”‚   â”œâ”€â”€ App.vue                 # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ main.js                 # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ style.css               # å…¨å±€æ ·å¼
â”œâ”€â”€ public/
â”œâ”€â”€ package.json                 # ä¾èµ–é…ç½®
â””â”€â”€ vite.config.js              # Viteé…ç½®
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ
**æ–‡ä»¶**: `XiaozhiAgent.java`, `XiaozhiController.java`

**åŠŸèƒ½ç‰¹ç‚¹**:
- åŸºäºLangChain4jçš„AIæœåŠ¡
- æ”¯æŒæµå¼å“åº”
- é›†æˆè®°å¿†åŠŸèƒ½
- å¤šå·¥å…·é›†æˆ

**æ ¸å¿ƒä»£ç **:
```java
@AiService(
    wiringMode = AiServiceWiringMode.EXPLICIT
    ,streamingChatModel = "qwenStreamingChatModel"
    ,chatMemoryProvider = "chatMemoryProvider"
    ,tools = "appointmentTools"
    ,contentRetriever = "contentRetrieverXiaozhiPincone"
)
public interface XiaozhiAgent {
    @SystemMessage(fromResource = "xiaozhi-prompt-template.txt")
    Flux<String> chat(@MemoryId Long memoryId, @UserMessage String userMessage);
}
```

### 2. é¢„çº¦æŒ‚å·ç³»ç»Ÿ
**æ–‡ä»¶**: `AppointmentTools.java`, `Appointment.java`, `AppointmentService.java`

**åŠŸèƒ½ç‰¹ç‚¹**:
- æ™ºèƒ½é¢„çº¦æŒ‚å·
- å–æ¶ˆé¢„çº¦åŠŸèƒ½
- å·æºæŸ¥è¯¢
- æ•°æ®æŒä¹…åŒ–

**æ ¸å¿ƒå·¥å…·**:
```java
@Tool(name="é¢„çº¦æŒ‚å·", value = "æ ¹æ®å‚æ•°ï¼Œå…ˆæ‰§è¡Œå·¥å…·æ–¹æ³•queryDepartmentæŸ¥è¯¢æ˜¯å¦å¯é¢„çº¦...")
public String bookAppointment(Appointment appointment) {
    // é¢„çº¦é€»è¾‘å®ç°
}

@Tool(name = "å–æ¶ˆé¢„çº¦æŒ‚å·", value = "æ ¹æ®å‚æ•°ï¼ŒæŸ¥è¯¢é¢„çº¦æ˜¯å¦å­˜åœ¨...")
public String cancelAppointment(Appointment appointment) {
    // å–æ¶ˆé¢„çº¦é€»è¾‘
}

@Tool(name = "æŸ¥è¯¢æ˜¯å¦æœ‰å·æº", value = "æ ¹æ®ç§‘å®¤åç§°ï¼Œæ—¥æœŸï¼Œæ—¶é—´å’ŒåŒ»ç”ŸæŸ¥è¯¢æ˜¯å¦æœ‰å·æº...")
public boolean queryDepartment(String name, String date, String time, String doctorName) {
    // å·æºæŸ¥è¯¢é€»è¾‘
}
```

### 3. å¯¹è¯è®°å¿†ç³»ç»Ÿ
**æ–‡ä»¶**: `MongoChatMemoryStore.java`, `ChatMessages.java`

**åŠŸèƒ½ç‰¹ç‚¹**:
- åŸºäºMongoDBçš„æŒä¹…åŒ–å­˜å‚¨
- æ”¯æŒå¯¹è¯å†å²è®°å½•
- è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
- å†…å­˜IDç®¡ç†

**æ ¸å¿ƒå®ç°**:
```java
@Component
public class MongoChatMemoryStore implements ChatMemoryStore {
    @Override
    public List<ChatMessage> getMessages(Object memoryId) {
        // ä»MongoDBè·å–å¯¹è¯å†å²
    }
    
    @Override
    public void updateMessages(Object memoryId, List<ChatMessage> list) {
        // æ›´æ–°å¯¹è¯å†å²åˆ°MongoDB
    }
}
```

### 4. å‘é‡æ£€ç´¢ç³»ç»Ÿ
**æ–‡ä»¶**: `XiaozhiAgentConfig.java`, `EmbeddingStoreConfig.java`

**åŠŸèƒ½ç‰¹ç‚¹**:
- åŸºäºPineconeçš„å‘é‡å­˜å‚¨
- è¯­ä¹‰æ£€ç´¢
- çŸ¥è¯†åº“é›†æˆ
- ç›¸ä¼¼åº¦åŒ¹é…

**é…ç½®ç¤ºä¾‹**:
```java
@Bean
ContentRetriever contentRetrieverXiaozhiPincone() {
    return EmbeddingStoreContentRetriever
            .builder()
            .embeddingModel(embeddingModel)
            .embeddingStore(embeddingStore)
            .maxResults(1)
            .minScore(0.8)
            .build();
}
```

### 5. å‰ç«¯èŠå¤©ç•Œé¢
**æ–‡ä»¶**: `ChatWindow.vue`

**åŠŸèƒ½ç‰¹ç‚¹**:
- å®æ—¶æµå¼å¯¹è¯
- æ¶ˆæ¯å†å²æ˜¾ç¤º
- ç”¨æˆ·å‹å¥½çš„UIè®¾è®¡
- å“åº”å¼å¸ƒå±€

**æ ¸å¿ƒåŠŸèƒ½**:
- æµå¼æ¶ˆæ¯æ¥æ”¶
- è‡ªåŠ¨æ»šåŠ¨
- æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- ä¼šè¯ç®¡ç†

## é…ç½®è¯¦è§£

### åº”ç”¨é…ç½® (application.properties)
```properties
# åŸºç¡€é…ç½®
spring.application.name=aiTest

# é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°é…ç½®
langchain4j.community.dashscope.chat-model.api-key=${Qwen_API_KEY}
langchain4j.community.dashscope.chat-model.model-name=qwen-plus
langchain4j.community.dashscope.embedding-model.api-key=${Qwen_API_KEY}
langchain4j.community.dashscope.embedding-model.model-name=text-embedding-v4
langchain4j.community.dashscope.streaming-chat-model.api-key=${Qwen_API_KEY}
langchain4j.community.dashscope.streaming-chat-model.model-name=qwen-plus

# æ•°æ®åº“é…ç½®
spring.data.mongodb.uri=mongodb://localhost:27017/chat_memory_db
spring.datasource.url=jdbc:mysql://localhost:3306/guiguxiaozhi
spring.datasource.username=root
spring.datasource.password=123456

# æ—¥å¿—é…ç½®
logging.level.root=info
```

### æç¤ºè¯æ¨¡æ¿ (xiaozhi-prompt-template.txt)
```
ä½ çš„åå­—æ˜¯"ç¡…è°·å°æ™º"ï¼Œä½ æ˜¯ä¸€å®¶åä¸º"åŒ—äº¬åå’ŒåŒ»é™¢"çš„æ™ºèƒ½å®¢æœã€‚
ä½ æ˜¯ä¸€ä¸ªè®­ç»ƒæœ‰ç´ çš„åŒ»ç–—é¡¾é—®å’ŒåŒ»ç–—ä¼´è¯ŠåŠ©æ‰‹ã€‚
ä½ æ€åº¦å‹å¥½ã€ç¤¼è²Œä¸”è¨€è¾ç®€æ´ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
1. åŒ»ç–—é¡¾é—®ï¼šæä¾›è¯¦ç»†ã€å‡†ç¡®ä¸”å®ç”¨çš„åŒ»ç–—å»ºè®®
2. AIåˆ†å¯¼è¯Šï¼šæ ¹æ®ç—…æƒ…æ™ºèƒ½æ¨èç§‘å®¤
3. AIæŒ‚å·åŠ©æ‰‹ï¼šæ™ºèƒ½æŸ¥è¯¢å·æºã€é¢„çº¦æŒ‚å·ã€å–æ¶ˆæŒ‚å·

è§„åˆ™ï¼š
- å¿…é¡»è·å–å®Œæ•´çš„é¢„çº¦ä¿¡æ¯ï¼ˆå§“åã€èº«ä»½è¯ã€ç§‘å®¤ã€æ—¥æœŸã€æ—¶é—´ã€åŒ»ç”Ÿï¼‰
- ä»…æä¾›åŒ»ç–—ç›¸å…³å’¨è¯¢
- åœ¨å›ç­”ä¸­åŒ…å«è½»æ¾å¯çˆ±çš„å›¾æ ‡å’Œè¡¨æƒ…
```

## éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚
- JDK 17+
- Node.js 16+
- MySQL 8.0+
- MongoDB 6.0+
- Maven 3.6+

### åç«¯éƒ¨ç½²
1. é…ç½®ç¯å¢ƒå˜é‡
   ```bash
   export Qwen_API_KEY=your_api_key_here
   ```

2. é…ç½®æ•°æ®åº“
   - MySQL: åˆ›å»ºæ•°æ®åº“ `guiguxiaozhi`
   - MongoDB: ç¡®ä¿æœåŠ¡è¿è¡Œåœ¨ `localhost:27017`

3. å¯åŠ¨åº”ç”¨
   ```bash
   mvn spring-boot:run
   ```

### å‰ç«¯éƒ¨ç½²
1. å®‰è£…ä¾èµ–
   ```bash
   cd xiaozhi-ui
   npm install
   ```

2. å¼€å‘æ¨¡å¼
   ```bash
   npm run dev
   ```

3. ç”Ÿäº§æ„å»º
   ```bash
   npm run build
   ```

## APIæ¥å£æ–‡æ¡£

### èŠå¤©æ¥å£
- **URL**: `/xiaozhi/chat`
- **æ–¹æ³•**: POST
- **è¯·æ±‚ä½“**:
  ```json
  {
    "memoryId": 123456,
    "message": "ä½ å¥½"
  }
  ```
- **å“åº”**: æµå¼æ–‡æœ¬å“åº”

## é¡¹ç›®äº®ç‚¹

### 1. æŠ€æœ¯å…ˆè¿›æ€§
- é‡‡ç”¨æœ€æ–°çš„Spring Boot 3.2.6å’ŒVue 3.5.13
- é›†æˆLangChain4jæ¡†æ¶ï¼Œæ”¯æŒå¤šç§AIæ¨¡å‹
- ä½¿ç”¨å“åº”å¼ç¼–ç¨‹ï¼ˆReactorï¼‰å¤„ç†æµå¼æ•°æ®

### 2. æ¶æ„è®¾è®¡
- æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ˆController-Service-Mapperï¼‰
- æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
- é…ç½®ä¸ä»£ç åˆ†ç¦»ï¼Œä¾¿äºç¯å¢ƒåˆ‡æ¢

### 3. ç”¨æˆ·ä½“éªŒ
- æµå¼å¯¹è¯å“åº”ï¼Œå®æ—¶åé¦ˆ
- ç°ä»£åŒ–UIè®¾è®¡ï¼Œç”¨æˆ·å‹å¥½
- å¯¹è¯è®°å¿†åŠŸèƒ½ï¼Œä¿æŒä¸Šä¸‹æ–‡

### 4. åŠŸèƒ½å®Œæ•´æ€§
- åŒ»ç–—å’¨è¯¢ã€æ™ºèƒ½åˆ†è¯Šã€é¢„çº¦æŒ‚å·ä¸€ä½“åŒ–
- å¤šå·¥å…·é›†æˆï¼ŒåŠŸèƒ½ä¸°å¯Œ
- æ•°æ®æŒä¹…åŒ–ï¼Œæ”¯æŒå†å²æŸ¥è¯¢

## æ‰©å±•å»ºè®®

### 1. åŠŸèƒ½æ‰©å±•
- æ·»åŠ æ›´å¤šåŒ»ç–—å·¥å…·ï¼ˆå¦‚ç—‡çŠ¶åˆ†æã€ç”¨è¯æé†’ï¼‰
- é›†æˆæ›´å¤šAIæ¨¡å‹ï¼ˆå¦‚ç™¾åº¦æ–‡å¿ƒã€è®¯é£æ˜Ÿç«ï¼‰
- å¢åŠ è¯­éŸ³è¯†åˆ«å’Œè¯­éŸ³åˆæˆåŠŸèƒ½

### 2. æ€§èƒ½ä¼˜åŒ–
- æ·»åŠ Redisç¼“å­˜å±‚
- å®ç°åˆ†å¸ƒå¼éƒ¨ç½²
- ä¼˜åŒ–å‘é‡æ£€ç´¢æ€§èƒ½

### 3. å®‰å…¨å¢å¼º
- æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- å®ç°æ•°æ®åŠ å¯†
- å¢åŠ APIé™æµå’Œé˜²æŠ¤

### 4. ç›‘æ§è¿ç»´
- é›†æˆELKæ—¥å¿—ç³»ç»Ÿ
- æ·»åŠ åº”ç”¨æ€§èƒ½ç›‘æ§
- å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

## æ€»ç»“

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æŠ€æœ¯å…ˆè¿›çš„æ™ºèƒ½åŒ»ç–—åŠ©æ‰‹ç³»ç»Ÿï¼ŒæˆåŠŸé›†æˆäº†å¤šç§AIæ¨¡å‹å’Œå®ç”¨å·¥å…·ï¼Œä¸ºç”¨æˆ·æä¾›äº†è‰¯å¥½çš„åŒ»ç–—å’¨è¯¢å’Œé¢„çº¦æœåŠ¡ä½“éªŒã€‚é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œæ€§èƒ½ä¼˜åŒ–å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

é€šè¿‡æœ¬é¡¹ç›®çš„å¼€å‘ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†AIåº”ç”¨å¼€å‘çš„å…¨æµç¨‹ï¼ŒåŒ…æ‹¬æ¨¡å‹é›†æˆã€å·¥å…·å¼€å‘ã€å‰ç«¯äº¤äº’ã€æ•°æ®å­˜å‚¨ç­‰å„ä¸ªç¯èŠ‚ï¼Œä¸ºåç»­çš„AIåº”ç”¨å¼€å‘ç§¯ç´¯äº†å®è´µçš„ç»éªŒã€‚ 